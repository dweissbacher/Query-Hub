# --- Query Metadata ---
# Human-readable name for the query. Will be displayed as the title.
name: Registry Persistence via Run Keys

# Unique identifier for the query.
id: T1547.001-registry-run-keys

# Description of what the query does and its purpose.
description: This query detects persistence mechanisms that use Windows Registry Run keys to automatically execute malware or maintain access across system reboots.

# The author or team that created the query.
author: Your Security Team

# The required log sources to run this query successfully in Next-Gen SIEM.
# This will be displayed in the UI to inform the user.
log_sources:
  - Endpoint
  - RegGenericEvent

# Tags for filtering and categorization.
# Include relevant techniques, tactics, or platforms.
tags:
  - Persistence
  - Registry
  - Boot Persistence
  - MITRE T1547.001

# --- Query Content ---
# The actual CrowdStrike Query Language (CQL) code.
# Using the YAML block scalar `|` allows for multi-line strings.
cql: |
  #event_simpleName=RegGenericEvent RegOperationType=SetValueKey
  | RegObjectName=/(HKEY_LOCAL_MACHINE|HKEY_CURRENT_USER).*\\(Run|RunOnce|RunServices|RunServicesOnce)/i
  | !RegValueName=/(SecurityHealth|Windows Security|OneDrive|VMware|Adobe)/i
  | join({#event_simpleName=UserIdentity}, field=AuthenticationID, include=[UserName])
  | table([aid, UserName, RegObjectName, RegValueName, RegStringValue, ProcessId])